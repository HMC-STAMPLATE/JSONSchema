stages:
  - upload
  - release

variables:
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stamplate"

upload:
  stage: upload
  image: node:lts
  # rules: 
  #   - if: $CI_COMMIT_TAG
  script:
    - |
      export PACKAGE_VERSION=$(node -p "require('./package.json').version")
    - |
      echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> build.env
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file stamplate.jsonld "${PACKAGE_REGISTRY_URL}/${PACKAGE_VERSION}/stamplate.jsonld"
  artifacts:
    reports:
      dotenv: build.env

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  # rules: 
  #   - if: $CI_COMMIT_TAG
  script:
    - |
      release-cli create --name "Release $PACKAGE_VERSION" --tag-name $PACKAGE_VERSION \
        --assets-link "{\"name\":\"stamplate.jsonld\",\"url\":\"${PACKAGE_REGISTRY_URL}/${PACKAGE_VERSION}/stamplate.jsonld\"}"

